# データベース変更履歴

## 2025-12-12 - DIARYテーブルに期限・解決者カラム追加

**変更日時**: 2025-12-12  
**変更内容**: 期限管理と解決者追跡のため、DIARYテーブルにカラムを追加

**SQL文**:
```sql
-- 期限カラム
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS deadline DATE;

-- 解決者カラム
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS solved_by INT REFERENCES "STAFF"(staff_id);

-- 解決日時カラム
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS solved_at TIMESTAMP WITH TIME ZONE;

-- 編集者カラム（既存）
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS updated_by INT REFERENCES "STAFF"(staff_id);
```

**変更理由**:
- `deadline`: 期限による枠線色分け（3日前から黄色、当日以降は赤）
- `solved_by`: 解決者のフルネーム表示
- `solved_at`: 解決日時の表示
- `updated_by`: 編集者の記録

**影響範囲**:
- `DIARY`テーブル
- 日報一覧表示（枠線の色分け）
- 解決済み表示（解決者名とタイムスタンプ）
- 日報編集機能

**注意事項**:
- 既存のレコードでは新カラムはNULLになります
- `deadline`は任意項目（設定しなくても投稿可能）
- `solved_by`と`solved_at`は解決ボタン押下時に自動設定

## 2025-12-12 - JOB_TYPEテーブルに論理削除用フラグ追加

**変更日時**: 2025-12-12  
**変更内容**: 職種（JOB_TYPE）の論理削除を可能にするため、is_activeカラムを追加

**SQL文**:
```sql
ALTER TABLE "JOB_TYPE" ADD COLUMN IF NOT EXISTS "is_active" boolean DEFAULT true NOT NULL;
```

**変更理由**:
- 職種カテゴリーの編集画面にて、使用しなくなった職種を削除（無効化）できるようにするため。
- CATEGORYテーブルには既にis_activeが存在するため、JOB_TYPEにも合わせる。

**影響範囲**:
- `JOB_TYPE`テーブル
- 職種一覧の取得処理（is_active=trueのみ取得するように変更が必要）

## 2025-12-12 - 掃除当番機能追加

**変更日時**: 2025-12-12  
**変更内容**: 掃除当番機能のため、DIARYテーブルにカラムを追加し、CLEANING_DUTY_ASSIGNMENTテーブルを新規作成

**SQL文**:
```sql
-- 日報の種別（通常/掃除当番など）
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS diary_type TEXT NOT NULL DEFAULT 'NORMAL';

-- 日報の宛先（NULL=全体公開、値あり=指定スタッフのみ表示）
ALTER TABLE "DIARY" ADD COLUMN IF NOT EXISTS target_staff_id INT REFERENCES "STAFF"(staff_id);

-- 掃除当番の割当テーブル（1日=1人）
CREATE TABLE IF NOT EXISTS "CLEANING_DUTY_ASSIGNMENT" (
  duty_date DATE PRIMARY KEY,
  staff_id INT NOT NULL REFERENCES "STAFF"(staff_id),
  created_by INT REFERENCES "STAFF"(staff_id),
  updated_by INT REFERENCES "STAFF"(staff_id),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS "cleaning_duty_assignment_staff_id_idx"
  ON "CLEANING_DUTY_ASSIGNMENT"(staff_id);

-- 掃除当番用カテゴリ（なければ追加）
INSERT INTO "CATEGORY" (category_name, is_active)
SELECT '掃除当番', true
WHERE NOT EXISTS (
  SELECT 1 FROM "CATEGORY" WHERE category_name = '掃除当番'
);

-- 掃除当番日報は「日付×種別」で一意（返信は除外）
CREATE UNIQUE INDEX IF NOT EXISTS "diary_cleaning_duty_unique"
  ON "DIARY"(target_date, diary_type)
  WHERE diary_type = 'CLEANING_DUTY' AND parent_id IS NULL;
```

**変更理由**:
- `diary_type`: 日報の種別を区別（通常日報と掃除当番日報を分離）
- `target_staff_id`: 特定のスタッフのみに表示する日報を実現（掃除当番は当番者のみに表示）
- `CLEANING_DUTY_ASSIGNMENT`: 掃除当番の割当を管理（1日につき1人の当番者を記録）

**影響範囲**:
- `DIARY`テーブル（新カラム追加）
- `CLEANING_DUTY_ASSIGNMENT`テーブル（新規作成）
- `CATEGORY`テーブル（「掃除当番」カテゴリの追加）
- 日報一覧表示（`target_staff_id`によるフィルタリング）
- 掃除当番カレンダー機能
- 掃除当番日報の自動生成機能

**注意事項**:
- `diary_type`のデフォルト値は`'NORMAL'`（既存レコードは自動的に`'NORMAL'`になる）
- `target_staff_id`がNULLの場合は全体公開（従来通りの動作）
- 掃除当番機能を使用しない場合は、これらのカラム/テーブルは未適用でもアプリは動作します（コード側でエラーハンドリング済み）

## 2025-12-15 - STAFFテーブルに非表示・削除フラグ追加

**変更日時**: 2025-12-15  
**変更内容**: ユーザー管理機能のため、STAFFテーブルに`is_hidden`と`is_deleted`カラムを追加

**SQL文**:
```sql
-- 非表示フラグ（産休などで一時的に非表示にする場合）
ALTER TABLE "STAFF" ADD COLUMN IF NOT EXISTS "is_hidden" boolean DEFAULT false NOT NULL;

-- 削除フラグ（退職などで完全に削除する場合、ただしデータは保持）
ALTER TABLE "STAFF" ADD COLUMN IF NOT EXISTS "is_deleted" boolean DEFAULT false NOT NULL;
```

**変更理由**:
- `is_hidden`: 産休などで一時的に休職するユーザーを非表示にする（メンションやバッチの宛先から除外、ただしユーザー管理画面には表示）
- `is_deleted`: 退職などで今後復帰の見込みがないユーザーを削除する（ユーザー管理画面にも表示されない、ただし過去記事では名前が表示される）

**影響範囲**:
- `STAFF`テーブル（新カラム追加）
- メンション機能（`getActiveStaff()`で`is_hidden=false`かつ`is_deleted=false`のみ取得）
- 確認済み・解決済みバッチ（非表示ユーザーは除外）
- ユーザー管理画面（全スタッフ一覧、非表示/削除の切り替え機能）

**注意事項**:
- 既存のレコードでは新カラムは`false`になります
- `is_deleted=true`のユーザーは過去記事では名前が表示されます（JOINで取得するため）
- `is_hidden=true`のユーザーはユーザー管理画面には表示されますが、メンションやバッチの宛先からは除外されます

## 2025-12-16 - 繰り返し投稿設定機能追加

**変更日時**: 2025-12-16  
**変更内容**: 繰り返し投稿設定機能のため、RECURRING_SETTINGSテーブルを新規作成し、DIARYテーブルにrecurring_idカラムを追加

**SQL文**:
```sql
-- 繰り返し設定テーブルの作成
CREATE TABLE "recurring_settings" (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  staff_id INT REFERENCES "STAFF"(staff_id) NOT NULL,
  title TEXT NOT NULL,
  content TEXT,
  category_id INT REFERENCES "CATEGORY"(category_id),
  is_urgent BOOLEAN DEFAULT false,
  bounty_points INT,
  deadline_interval INT, -- 期限までの日数（もしあれば）
  
  recurrence_type TEXT NOT NULL, -- 'daily', 'weekly', 'monthly', 'yearly', 'custom'
  recurrence_config JSONB NOT NULL, -- 詳しい設定内容
  
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  
  is_active BOOLEAN DEFAULT true,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- DIARYテーブルに参照カラムを追加
ALTER TABLE "DIARY" ADD COLUMN recurring_id BIGINT REFERENCES "recurring_settings"(id);

-- インデックス作成（検索高速化のため）
CREATE INDEX idx_diary_recurring_id ON "DIARY"(recurring_id);
CREATE INDEX idx_recurring_settings_staff_id ON "recurring_settings"(staff_id);
```

**変更理由**:
- `recurring_settings`: 繰り返し投稿の設定を保存（頻度、開始日、終了日、曜日指定など）
- `recurring_id`: 個別の日報エントリがどの繰り返し設定から生成されたかを追跡
- 頻度変更、終了日変更、一時停止、削除などの管理機能を実現

**影響範囲**:
- `recurring_settings`テーブル（新規作成）
- `DIARY`テーブル（`recurring_id`カラム追加）
- 新規投稿ページ（繰り返し設定の入力UI）
- 繰り返し投稿の管理ページ（`/settings/recurrence`）
- 日報生成ロジック（繰り返し設定に基づく日報の自動生成）

**注意事項**:
- `recurring_id`がNULLの場合は通常の単発投稿（既存の動作）
- 繰り返し設定を削除した場合、過去の日報の`recurring_id`はNULLに設定される（データ整合性のため）
- 頻度変更や終了日変更時は、未来の未読日報が自動的に削除される
- `recurrence_config`はJSONB型で、頻度タイプに応じた詳細設定（曜日、間隔など）を保存

## 2025-12-16 - 完全削除機能追加（中間テーブル）

**変更日時**: 2025-12-16  
**変更内容**: 削除済みユーザーを画面から完全に非表示にするための中間テーブルを新規作成

**SQL文**:
```sql
-- 完全削除スタッフ中間テーブル（小文字で作成）
CREATE TABLE IF NOT EXISTS permanently_deleted_staff (
  staff_id INT PRIMARY KEY REFERENCES "STAFF"(staff_id) ON DELETE CASCADE,
  deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

COMMENT ON TABLE permanently_deleted_staff IS '完全削除されたスタッフを記録（UI非表示だがデータ保持）';
```

**変更理由**:
- 削除済みユーザーを管理画面からも完全に非表示にする機能を追加
- STAFFテーブルにカラム追加せず、中間テーブルで管理することで既存コードへの影響を最小化
- 物理削除しないため、過去の投稿との整合性を保持

**状態の定義**:
| STAFF.is_deleted | permanently_deleted_staff | 状態 | 画面表示 |
|------------------|---------------------------|------|----------|
| false | なし | アクティブ | ユーザー管理 |
| true | なし | 削除済み | 削除済みセクション（復元可能） |
| true | あり | 完全削除 | なし（DB保持） |

**影響範囲**:
- `permanently_deleted_staff`テーブル（新規作成）
- ユーザー管理画面（削除済みユーザーの折りたたみ表示、復元/完全削除ボタン）

**注意事項**:
- 完全削除は管理画面からの復元が不可（Supabase管理画面からは可能）
- 完全削除されたユーザーの過去投稿は引き続き表示される
- テーブル名は小文字（Supabaseスキーマキャッシュ対応のため）
