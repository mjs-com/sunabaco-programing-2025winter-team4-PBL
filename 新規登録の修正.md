# 新規登録フローと承認プロセスの修正計画

## 現状の課題
1.  新規登録時のメール確認リンクをクリックすると、localhostのエラー画面に遷移してしまう（本番環境での発生を防ぐ必要がある）。
2.  メール確認が完了すると、管理者の承認（`STAFF`テーブルの`is_active`フラグ）を待たずにログインできてしまう。

## 目的
1.  メール確認完了後に「登録完了・承認待ち」のメッセージを表示する専用ページへ誘導する（本番URL対応）。
2.  管理者が承認するまで、システムへのログイン（内部ページへのアクセス）をブロックする。

## 修正手順

### 1. 「承認待ち」画面の作成
*   **ファイル:** `src/app/auth/pending/page.tsx`
*   **内容:** 「メールアドレスの確認が完了しました。管理者がアカウントを承認するまでお待ちください。」という旨を表示する静的なページ。
*   **機能:** ログアウトボタンを設置し、別の正規アカウントでのログインフローに戻れるようにする。
*   **状態:** 作成済み

### 2. 認証コールバック処理の実装
*   **ファイル:** `src/app/auth/callback/route.ts`
*   **内容:** Supabase Authのメールリンクに含まれる `code` を受け取り、セッションと交換する処理。
*   **URL処理:** リクエストの `origin` を動的に取得するため、Vercel環境（`https://...vercel.app`）でも自動的に正しいドメインで動作します。
*   **状態:** 作成済み

### 3. 新規登録アクションの修正（本番URL対応）
*   **ファイル:** `src/app/actions/auth.ts`
*   **内容:** `signUp` 実行時に `emailRedirectTo` オプションを追加。
*   **ロジック:** 実行時のヘッダー情報から `origin` を取得し、`${origin}/auth/callback` をリダイレクト先に指定します。これにより、localhost環境でも本番環境でも、その環境に適したURLがメールリンクとして生成されます。
*   **状態:** 修正済み

### 4. ミドルウェアでの承認チェック追加
*   **ファイル:** `src/lib/supabase/middleware.ts`
*   **内容:** ページ遷移ごとのセッションチェックに加え、ユーザーの承認状態を確認する。
*   **ロジック:** 未承認ユーザーは `/auth/pending` 以外へのアクセスをブロックする。
*   **状態:** 修正済み

## ユーザー作業手順（重要）

本番環境（Vercel）で正しく動作させるために、**Supabaseの管理画面で以下の設定を追加してください**。

### Supabase Redirect URLの設定
1.  Supabase Dashboardにログインし、対象のプロジェクトを開く。
2.  左メニューから **Authentication** > **URL Configuration** を選択。
3.  **Redirect URLs** のセクションにある「Add URL」をクリック。
4.  本番環境のURLに `/auth/callback` を付与したURLを追加する。
    *   追加するURL: `https://sunabaco-programing-2025winter-team-ruby.vercel.app/auth/callback`
    *   （もしプレビュー環境などもあれば、`https://*-team-ruby.vercel.app/**` のようなワイルドカード指定も検討してください）
5.  **Save** をクリックして保存。

### 動作確認
1.  本番環境のアプリ（`https://sunabaco-programing-2025winter-team-ruby.vercel.app/`）にアクセス。
2.  新規登録を行う。
3.  届いたメールを確認し、リンク先が `https://sunabaco-programing-2025winter-team-ruby.vercel.app/...` で始まっていることを確認（localhostになっていないこと）。
4.  リンクをクリックし、「登録手続き完了」ページが表示されることを確認。
5.  管理者による承認後、ログインできることを確認。
