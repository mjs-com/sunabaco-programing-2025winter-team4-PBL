# スプレッドシート出力計画書

## 1. 概要

月1回、Supabaseに蓄積された日報データ（DIARYテーブル）をGoogle スプレッドシートに出力し、日報の分析・可視化を行うための計画書です。

---

## 2. システム構成案

### 2.1 構成パターン比較

| 構成パターン | 概要 | メリット | デメリット | 推奨度 |
|-------------|------|---------|-----------|--------|
| **A. アプリ内ボタン方式** | 管理画面に「エクスポート」ボタンを設置し、手動でスプレッドシートに出力 | シンプル、ユーザー任意のタイミングで実行可能 | 毎月手動操作が必要 | ⭐⭐⭐ |
| **B. Supabase Edge Functions + Cron** | Supabaseの Edge Functions と pg_cron で月1回自動実行 | 完全自動化、アプリ側の改修不要 | 設定がやや複雑 | ⭐⭐⭐⭐ |
| **C. Google Apps Script (GAS)** | GAS側からSupabaseのAPIを定期実行で取得 | スプレッドシート側で完結、柔軟な加工が可能 | APIキー管理が必要 | ⭐⭐⭐⭐⭐ |
| **D. 外部ツール連携 (Zapier等)** | Zapier/Make等でSupabase→スプレッドシート連携 | ノーコードで設定可能 | 月額費用が発生する場合あり | ⭐⭐ |

### 2.2 推奨構成：C. Google Apps Script (GAS) 方式

**理由：**
- スプレッドシート側で完結するため、アプリ側の改修が最小限
- スケジュール実行（トリガー）が無料で利用可能
- データ加工・整形がGAS内で柔軟に行える
- スプレッドシートの関数やピボットテーブルと連携しやすい

### 2.3 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Google Spreadsheet                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ 生データシート │  │ 分析シート   │  │ ダッシュボードシート  │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│         ▲                                                    │
│         │                                                    │
│  ┌──────┴──────┐                                            │
│  │ Google Apps  │  ← 月1回自動実行（トリガー）               │
│  │   Script     │                                            │
│  └──────┬──────┘                                            │
└─────────│───────────────────────────────────────────────────┘
          │ REST API (HTTPS)
          ▼
┌─────────────────────────────────────────────────────────────┐
│                      Supabase                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    DIARY テーブル                     │   │
│  │  (+ STAFF, CATEGORY, TAG 等の関連テーブル)           │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 出力項目の検討

### 3.1 基本項目（ユーザー提案）

| No | 項目名 | DBカラム | 説明 |
|----|--------|----------|------|
| 1 | 日付 | target_date | 記事の対象日付 |
| 2 | 投稿時刻 | created_at | 投稿日時 |
| 3 | 解決日時 | solved_at | 解決完了した日時 |
| 4 | カテゴリ | category.category_name | 記事のカテゴリ名 |
| 5 | 入力者職種 | staff.job_type.job_name | 投稿者の職種 |
| 6 | 入力者名 | staff.name | 投稿者の名前 |
| 7 | 宛先 | target_staff.name | 宛先スタッフ名（NULL=全体） |
| 8 | 本文 | content | 日報の本文内容 |
| 9 | 返信文 | （親記事への返信を結合） | 返信のcontent |

### 3.2 分析のために追加を推奨する項目

| No | 項目名 | DBカラム/算出方法 | 分析での活用 |
|----|--------|------------------|-------------|
| 10 | **日報ID** | diary_id | 一意識別子、データ突合用 |
| 11 | **タイトル** | title | 話題・トラブルの把握 |
| 12 | **現在ステータス** | current_status | 未読/確認済/対応中/解決の割合分析 |
| 13 | **緊急フラグ** | is_urgent | 緊急案件の発生頻度 |
| 14 | **タグ** | tags (結合) | 話題やトラブルの分類 |
| 15 | **返信数** | COUNT(replies) | 議論の活発さ |
| 16 | **解決者名** | solved_by_staff.name | 誰が多く解決しているか |
| 17 | **解決者職種** | solved_by_staff.job_type.job_name | 職種別の対応負担 |
| 18 | **対応時間（時間）** | solved_at - created_at | 課題解決のスピード |
| 19 | **期限** | deadline | 期限管理の分析 |
| 20 | **期限超過フラグ** | solved_at > deadline | 期限遵守率 |
| 21 | **特別報酬ポイント** | bounty_points | 重要案件の把握 |
| 22 | **日報種別** | diary_type | NORMAL/CLEANING_DUTY の区別 |
| 23 | **宛先職種** | target_staff.job_type.job_name | 職種間連携の分析 |
| 24 | **曜日** | target_dateから算出 | 曜日別傾向分析 |
| 25 | **週番号** | target_dateから算出 | 週次トレンド分析 |

### 3.3 最終推奨出力項目リスト

```
【必須項目】
1.  日報ID
2.  対象日付
3.  曜日
4.  週番号
5.  投稿日時
6.  タイトル
7.  本文
8.  カテゴリ
9.  タグ（カンマ区切り）
10. 緊急フラグ
11. 日報種別
12. 入力者名
13. 入力者職種
14. 宛先（全体/個人名）
15. 宛先職種
16. 現在ステータス
17. 解決日時
18. 解決者名
19. 解決者職種
20. 対応時間（時間）
21. 期限
22. 期限超過フラグ
23. 返信数
24. 特別報酬ポイント
```

---

## 4. 分析活用例

### 4.1 話題・トラブル分析
| 分析内容 | 使用項目 | 手法 |
|----------|----------|------|
| 多かったカテゴリ | カテゴリ | ピボットテーブルで集計 |
| 多かったタグ | タグ | タグごとの出現回数集計 |
| 緊急案件の傾向 | 緊急フラグ, カテゴリ | クロス集計 |
| 曜日別発生傾向 | 曜日, カテゴリ | 曜日×カテゴリのヒートマップ |

### 4.2 業務負担の可視化
| 分析内容 | 使用項目 | 手法 |
|----------|----------|------|
| 投稿数ランキング | 入力者名 | 投稿者別カウント |
| 対応数ランキング | 解決者名 | 解決者別カウント |
| 職種別業務量 | 入力者職種, 解決者職種 | 職種ごとの投稿/対応数 |
| 宛先として多い人 | 宛先 | 宛先別カウント（業務集中度） |
| 平均対応時間 | 対応時間, 解決者名 | 人別・職種別の平均値 |

### 4.3 業務効率・品質分析
| 分析内容 | 使用項目 | 手法 |
|----------|----------|------|
| 未解決案件の割合 | 現在ステータス | ステータス別カウント |
| 期限遵守率 | 期限超過フラグ | 超過件数/期限あり件数 |
| 週次トレンド | 週番号, 各種項目 | 週単位での推移グラフ |
| カテゴリ別対応速度 | カテゴリ, 対応時間 | カテゴリごとの平均対応時間 |

---

## 5. 実装計画

### 5.1 Phase 1：手動エクスポート機能（優先度：高）

**目的：** まずは管理画面から手動でデータ出力できる機能を実装

**実装内容：**
1. 管理画面に「月次レポート出力」ボタンを追加
2. 指定期間のデータをCSV形式でダウンロード
3. ダウンロードしたCSVをスプレッドシートにインポート

**必要な開発：**
- `src/app/actions/export.ts` - エクスポート用Server Action
- `src/app/admin/export/page.tsx` - エクスポート画面
- CSVダウンロード機能

### 5.2 Phase 2：Google Apps Script連携（優先度：中）

**目的：** 月1回自動でスプレッドシートに出力

**実装内容：**
1. Supabase REST APIエンドポイントの設定
2. Google Apps Scriptの作成
3. 月次トリガーの設定
4. スプレッドシートテンプレートの作成

**GASサンプルコード（参考）：**
```javascript
function fetchMonthlyDiaryData() {
  const SUPABASE_URL = 'https://your-project.supabase.co';
  const SUPABASE_KEY = 'your-anon-key';
  
  // 先月の期間を計算
  const today = new Date();
  const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
  
  const startDate = Utilities.formatDate(lastMonth, 'JST', 'yyyy-MM-dd');
  const endDate = Utilities.formatDate(lastMonthEnd, 'JST', 'yyyy-MM-dd');
  
  // Supabase APIからデータ取得
  const url = `${SUPABASE_URL}/rest/v1/DIARY?target_date=gte.${startDate}&target_date=lte.${endDate}&select=*,STAFF(*),CATEGORY(*),solved_by_staff:STAFF!solved_by(*)`;
  
  const options = {
    'method': 'GET',
    'headers': {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const data = JSON.parse(response.getContentText());
  
  // スプレッドシートに出力
  writeToSheet(data);
}

function writeToSheet(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('生データ') || ss.insertSheet('生データ');
  
  // ヘッダー行
  const headers = ['日報ID', '対象日付', '曜日', '投稿日時', 'タイトル', '本文', 
                   'カテゴリ', '緊急', '入力者名', '入力者職種', '宛先', 
                   'ステータス', '解決日時', '解決者名', '対応時間(時間)'];
  
  // データ整形と出力
  const rows = data.map(diary => [
    diary.diary_id,
    diary.target_date,
    getDayOfWeek(diary.target_date),
    diary.created_at,
    diary.title,
    diary.content,
    diary.CATEGORY?.category_name || '',
    diary.is_urgent ? 'はい' : 'いいえ',
    diary.STAFF?.name || '',
    diary.STAFF?.JOB_TYPE?.job_name || '',
    diary.target_staff_id ? '個人宛' : '全体',
    diary.current_status,
    diary.solved_at || '',
    diary.solved_by_staff?.name || '',
    calculateHours(diary.created_at, diary.solved_at)
  ]);
  
  sheet.clear();
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  if (rows.length > 0) {
    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  }
}
```

### 5.3 Phase 3：分析ダッシュボード（優先度：低）

**目的：** スプレッドシート上で自動分析・可視化

**実装内容：**
1. ピボットテーブルシートの作成
2. グラフ・チャートの自動生成
3. 月次比較機能

---

## 6. スプレッドシート構成案

```
📊 日報月次レポート_YYYY年MM月
├── 📋 生データ          ← GASで自動出力されるシート
├── 📈 カテゴリ分析       ← ピボットテーブル（カテゴリ別集計）
├── 👥 担当者分析         ← ピボットテーブル（投稿者/対応者別集計）
├── ⏱️ 対応時間分析       ← 対応時間の統計・グラフ
├── 📅 曜日・週次分析     ← 曜日別・週別の傾向
└── 📊 ダッシュボード     ← 主要KPIのサマリー
```

---

## 7. セキュリティ考慮事項

| 項目 | 対策 |
|------|------|
| APIキーの管理 | GASのスクリプトプロパティに保存（コードに直書きしない） |
| アクセス制限 | スプレッドシートの共有設定を適切に管理 |
| 個人情報 | 必要に応じてスタッフ名をIDに置換するオプション |
| データ保持 | 月次シートをアーカイブし、古いデータは別ファイルへ |

---

## 8. 今後の拡張案

1. **リアルタイム連携**: Supabase Realtime + Webhookで即時同期
2. **アラート機能**: 未解決案件が一定数を超えたらSlack通知
3. **AI分析**: OpenAI APIで本文を自動分類・要約
4. **PDF出力**: 月次レポートをPDFで自動生成

---

## 9. まとめ

### 現在考えている項目の評価

ユーザーが提案された9項目（日付、時刻、解決日時、カテゴリ、入力者職種、入力者名、宛先、本文、返信文）は基本的な分析には十分ですが、**より深い分析を行うために以下の項目追加を推奨します：**

- **必須追加**: 日報ID、タイトル、現在ステータス、タグ、解決者名、解決者職種、対応時間
- **推奨追加**: 緊急フラグ、期限、期限超過フラグ、曜日、週番号

### 推奨実装順序

1. **Phase 1（1週間）**: 管理画面からの手動CSVエクスポート機能
2. **Phase 2（2週間）**: GASによる自動連携
3. **Phase 3（随時）**: 分析ダッシュボードの充実

---

*作成日: 2025年12月15日*
