# 繰り返し投稿の修正案

## 概要
繰り返し投稿機能に関する3つの問題を修正しました。

---

## 問題1: 毎週の繰り返し投稿でエラーが出る ✅ 修正完了

### 現象
- 繰り返し投稿を「毎週」に設定すると「繰り返し日付が生成されませんでした」というエラーが出て投稿できない

### 原因
`src/app/post/page.tsx` の232行目で、`recurrenceType === 'weekly'` の場合に `weekDays` が空配列 `[]` として渡されていた。

`src/app/actions/diary.ts` の `generateRecurringDates` 関数では、空配列はtruthy（真）なので `|| [start.getDay()]` のデフォルト値が適用されず、曜日がマッチしないため日付が生成されなかった。

### 修正内容
`diary.ts` の `generateRecurringDates` 関数で、`weekDays` が空配列または未定義の場合に開始日の曜日をデフォルトとして使用するように修正。

```typescript
// 修正前
const weekDays = config.weekDays || [start.getDay()];

// 修正後
const weekDays = (config.weekDays && config.weekDays.length > 0) 
  ? config.weekDays 
  : [start.getDay()];
```

---

## 問題2: 繰り返し投稿の削除で選択肢がない ✅ 修正完了

### 現象
- トップページに表示されている繰り返し投稿を削除しても、それ以降の繰り返し投稿が続いてしまう
- 「この記事のみ削除」か「この記事以降すべての繰り返し投稿を削除」を選べるようにしたい

### 原因
現在の `deleteDiary` 関数は単一の日報のみを論理削除する。繰り返し投稿の関連性を考慮していない。

### 修正内容
1. `diary.ts` に以下の関数を追加：
   - `deleteRecurringDiary(diaryId, staffId, mode)` - 繰り返し投稿の削除
     - `mode: 'single'` - この記事のみ削除
     - `mode: 'future'` - この記事以降すべての繰り返し投稿を削除（未読のみ）
   - `checkIfRecurringDiary(diaryId)` - 繰り返し投稿かどうかを確認
   
2. `DiaryDetailModal.tsx` を修正：
   - 削除ボタンクリック時に繰り返し投稿かどうかをチェック
   - 繰り返し投稿の場合は選択肢を表示するUIを追加

---

## 問題3: 未解決記事で繰り返し投稿が重複表示される ✅ 修正完了

### 現象
- トップページの「未解決の記事をすべて表示」を押したときに、繰り返し投稿の内容が全て表示されてしまう
- タイトルと本文が同じものは1つだけ表示してほしい

### 原因
`getAllUnsolvedDiaries` 関数が繰り返し投稿の重複排除をしていない。

### 修正内容
`diary.ts` の `getAllUnsolvedDiaries` 関数で、同じ `recurring_id` を持つ日報のうち、`target_date` が今日に最も近いものだけを表示するように修正。

```typescript
// 繰り返し投稿の重複排除
const uniqueDiaries = diaries.reduce((acc, diary) => {
  if (!diary.recurring_id) {
    // 繰り返しでない日報はそのまま追加
    acc.push(diary);
  } else {
    // 同じ recurring_id がすでにあるかチェック
    const existingIndex = acc.findIndex(d => d.recurring_id === diary.recurring_id);
    if (existingIndex === -1) {
      // なければ追加
      acc.push(diary);
    } else {
      // あれば、より日付が今日に近いものを残す
      // ...
    }
  }
  return acc;
}, [] as DiaryWithRelations[]);
```

---

## 修正ファイル一覧

1. `src/app/actions/diary.ts`
   - ✅ `generateRecurringDates` 関数の修正（問題1）
   - ✅ `deleteRecurringDiary` 関数の追加（問題2）
   - ✅ `checkIfRecurringDiary` 関数の追加（問題2）
   - ✅ `getAllUnsolvedDiaries` 関数の修正（問題3）

2. `src/components/diary/DiaryDetailModal.tsx`
   - ✅ 削除時の確認ダイアログに選択肢を追加（問題2）
   - ✅ 繰り返し投稿かどうかのチェック処理を追加

---

## 実装状況

1. ✅ 修正案ドキュメント作成
2. ✅ 問題1修正: `diary.ts` の `generateRecurringDates` 関数
3. ✅ 問題2修正: `diary.ts` に `deleteRecurringDiary` 関数追加 + `DiaryDetailModal.tsx` の修正
4. ✅ 問題3修正: `diary.ts` の `getAllUnsolvedDiaries` 関数

---

## 使い方

### 毎週の繰り返し投稿
- 投稿画面で「繰り返し」をONにし、パターンを「毎週（同じ曜日）」に設定
- 開始日の曜日が自動的に繰り返し曜日として使用されます

### 繰り返し投稿の削除
1. 削除したい日報の詳細を開く
2. 削除ボタンをクリック
3. 繰り返し投稿の場合、以下の選択肢が表示される：
   - **この記事のみ削除**: 選択した日報だけを削除
   - **この記事以降すべて削除（未読のみ）**: 選択した日報以降の未読の繰り返し投稿をすべて削除

### 未解決記事の表示
- 「未解決の記事すべてを表示する」ボタンをクリック
- 繰り返し投稿は重複排除され、今日に最も近い日付のものだけが表示されます
