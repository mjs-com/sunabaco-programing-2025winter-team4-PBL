# ログイン回りの修正計画書

作成日: 2024/12/17
ステータス: **✅ 実装完了**

## 本番環境URL
**https://sunabaco-programing-2025winter-team-ruby.vercel.app/**

## データベース変更
**カラム追加: 不要** ✅

メールアドレス変更時の一時データ（`old_email`, `pending_staff_id`）は、Supabase Authの`user_metadata`（標準機能）に保存するため、STAFFテーブルやDBスキーマへの変更は不要です。

---

## 1. 要件

### 1.1 マイページでの氏名・メールアドレス変更機能
- マイページ（設定ボタン > マイページ）から自分の名前とログイン用メールアドレスを変更できるようにする

### 1.2 パスワードリセット機能
- ログイン画面に「パスワードを忘れた方用の再設定リンク」を設置する

---

## 2. 実装内容

### 2.1 パスワードリセット機能 ✅

#### 変更ファイル
| ファイル | 変更内容 |
|----------|----------|
| `src/app/actions/auth.ts` | `resetPassword`関数と`updatePasswordAfterReset`関数を追加 |
| `src/app/login/page.tsx` | パスワードリセットリンクとフォームを追加 |
| `src/app/auth/reset-password/page.tsx` | **新規作成** - パスワード再設定ページ |
| `src/app/auth/callback/route.ts` | パスワードリセット（recovery）のハンドリング追加 |
| `src/lib/supabase/middleware.ts` | パスワードリセットページへのアクセス許可追加 |

#### 処理フロー
```
1. ログイン画面で「パスワードを忘れた方はこちら」をクリック
2. メールアドレス入力フォームが表示される
3. メールアドレス入力後、「リセットメールを送信」をクリック
4. supabase.auth.resetPasswordForEmail() でリセットメール送信
5. ユーザーがメール内リンクをクリック
6. auth/callback → verifyOtp(type: 'recovery') でセッション確立
7. /auth/reset-password へリダイレクト
8. 新パスワード入力・更新完了
9. ログインページへリダイレクト
```

### 2.2 氏名変更機能 ✅

#### 変更ファイル
| ファイル | 変更内容 |
|----------|----------|
| `src/app/actions/profile.ts` | `updateProfile`関数を名前のみ更新に変更 |
| `src/app/mypage/page.tsx` | 名前とメール変更の処理を分離 |

#### 処理フロー
```
1. マイページで名前を編集
2. 「保存」をクリック
3. STAFFテーブルの name を即座に更新
4. 日報などの表示名は自動的に更新（JOINで取得しているため）
```

### 2.3 メールアドレス変更機能 ✅

#### 変更ファイル
| ファイル | 変更内容 |
|----------|----------|
| `src/app/actions/profile.ts` | `requestEmailChange`関数を新規追加 |
| `src/app/auth/callback/route.ts` | メール変更確認（email_change）のハンドリング追加 |
| `src/app/mypage/page.tsx` | メール変更時の確認メール案内を追加 |

#### 処理フロー（安全な実装）
```
1. マイページでメールアドレスを編集
2. 「保存」をクリック
3. 新しいメールアドレスの重複チェック
4. user_metadata に古いメールアドレスと staff_id を保存
5. supabase.auth.updateUser({ email }) で確認メール送信
6. STAFFテーブルは**この時点では更新しない**
7. ユーザーが確認メール内のリンクをクリック
8. auth/callback → verifyOtp(type: 'email_change')
9. user_metadata から staff_id を取得
10. STAFFテーブルの email を更新
11. /mypage?email_changed=true へリダイレクト
```

#### セキュリティ上の利点
- メール確認完了まで STAFF テーブルは更新されないため、誤入力によるログイン不能を防止
- Auth側とSTAFF側のメールアドレスの整合性が保たれる

---

## 3. 注意事項

### 3.1 Supabase設定の確認（⚠️重要）

以下の設定を確認・変更してください：

1. **🔴 Secure email change を OFF にする（必須）**
   - Supabase Dashboard > Authentication > Providers > Email
   - 「Secure email change」を **OFF** にする
   - ONの場合、古いメールと新しいメール両方で確認が必要になり、動作が複雑になります

2. **Redirect URLs の設定**
   - Supabase Dashboard > Authentication > URL Configuration
   - 以下のURLを追加してください：
     - `https://sunabaco-programing-2025winter-team-ruby.vercel.app/auth/callback`

3. **Site URL の設定**
   - Supabase Dashboard > Authentication > URL Configuration
   - Site URL: `https://sunabaco-programing-2025winter-team-ruby.vercel.app`

4. **メールテンプレートの確認**
   - Supabase Dashboard > Authentication > Email Templates
   - 「Change Email Address」テンプレートの確認リンクが正しいか確認

### 3.2 環境変数
- `NEXT_PUBLIC_SITE_URL`: 本番環境では以下を設定してください
  - `https://sunabaco-programing-2025winter-team-ruby.vercel.app`
  - リセットメールや確認メールのリンク先URLに使用されます

- `SUPABASE_SERVICE_ROLE_KEY`: **メールアドレス変更機能に必須**
  - Supabase Dashboard > Settings > API > service_role key
  - この秘密鍵を Vercel の環境変数に設定してください
  - ⚠️ **この鍵は絶対に公開しないでください**（NEXT_PUBLIC_ プレフィックスは付けない）

---

## 4. テスト項目

### パスワードリセット
- [ ] ログイン画面で「パスワードを忘れた方はこちら」リンクが表示される
- [ ] メールアドレス入力後、リセットメールが送信される
- [ ] メール内のリンクからパスワード再設定ページに遷移できる
- [ ] 新パスワードを設定後、ログインできる

### 名前変更
- [ ] マイページで名前を変更できる
- [ ] 変更後、日報の投稿者名が新しい名前で表示される

### メールアドレス変更
- [ ] マイページでメールアドレス変更をリクエストできる
- [ ] 「確認メールを送信しました」メッセージが表示される
- [ ] 確認メールが新しいアドレスに届く
- [ ] 確認完了前は古いメールでログインできる
- [ ] 確認完了後は新しいメールでログインできる
- [ ] STAFFテーブルのemailが正しく更新される

---

## 5. 変更ファイル一覧（最終）

| ファイル | 状態 | 内容 |
|----------|------|------|
| `src/app/actions/auth.ts` | 修正 | resetPassword, updatePasswordAfterReset 追加 |
| `src/app/login/page.tsx` | 修正 | パスワードリセットUI追加 |
| `src/app/auth/reset-password/page.tsx` | **新規** | パスワード再設定ページ |
| `src/app/auth/callback/route.ts` | 修正 | recovery, email_change ハンドリング |
| `src/lib/supabase/middleware.ts` | 修正 | reset-passwordページ許可 |
| `src/app/actions/profile.ts` | 修正 | updateProfile分離, requestEmailChange追加 |
| `src/app/mypage/page.tsx` | 修正 | メール変更UI改善 |

---

## 6. 実装完了

すべてのタスクが完了しました。
