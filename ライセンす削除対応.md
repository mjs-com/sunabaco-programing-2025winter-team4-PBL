# ユーザー削除（論理削除）対応の修正方針

## 問題点（前回の実装）

前回の実装では、削除時にメールアドレスを `deleted_{timestamp}_{email}` に変更していました。
これには以下の問題があります：

1. **不自然な設計**: 一般的なサービスでは、退会しても同じメールアドレスで再入会できることが多い
2. **復元が困難**: メールアドレスを変えてしまうと、誤削除時の復元が面倒
3. **複雑すぎる**: Supabase AuthとDB両方の整合性を保つ処理が複雑

## 一般的なパターン

### サブスクリプション型サービスの典型的な挙動

1. **退会/削除**: アカウントは「無効」になるが、データは保持される（論理削除）
2. **再入会/復元**: 管理者または本人の操作で「有効」に戻せる
3. **ログイン制御**: 無効なアカウントでログインすると「このアカウントは無効です」等の画面が表示される

→ **同一アカウント（メールアドレス）の再利用が可能**

## 推奨する修正方針（シンプル版）

### 1. 削除操作
- `STAFF.is_deleted = true` にするだけ
- メールアドレスは変更しない
- Supabase Authのユーザーも削除しない

### 2. ログイン制御（既存のままでOK）
- ミドルウェアで `is_deleted` をチェック
- `true` の場合は「アカウント削除済み」画面へリダイレクト
- この画面からログアウト可能

### 3. 復元操作
- 管理者が `is_deleted = false` に戻すだけで再ログイン可能
- 過去のデータ（投稿履歴など）も維持される

### 4. 完全削除が必要な場合（レアケース）
- 管理者がSupabase管理画面から手動でAuthユーザーを削除
- これにより、同じメールアドレスで完全新規登録が可能になる

## 修正内容

### `src/app/actions/admin.ts` の `toggleStaffDeleted` 関数

**変更前（複雑）**:
- 削除時にメールアドレスをダミー化
- 復元をサポートしない

**変更後（シンプル）**:
- 削除時は `is_deleted = true` にするだけ
- 復元時は `is_deleted = false` にするだけ

```typescript
export async function toggleStaffDeleted(staffId: number, isDeleted: boolean) {
  // ... 権限チェック等 ...

  // 削除または復元（フラグを切り替えるだけ）
  const { error } = await supabase
    .from('STAFF')
    .update({ 
      is_deleted: isDeleted,
      updated_at: new Date().toISOString()
    })
    .eq('staff_id', staffId);

  // ... エラーハンドリング等 ...
}
```

## フロー図

```
[管理者がユーザーを削除]
        ↓
[STAFF.is_deleted = true]
        ↓
[ユーザーがログイン試行]
        ↓
[Supabase Auth認証 → 成功]
        ↓
[ミドルウェアでSTAFF.is_deletedをチェック]
        ↓
[is_deleted = true なので /auth/account-deleted へリダイレクト]
        ↓
[「アカウントは削除されています」画面表示]
        ↓
[ログアウトボタンでログイン画面へ]

[管理者がユーザーを復元]
        ↓
[STAFF.is_deleted = false]
        ↓
[ユーザーは再度ログイン可能]
```

## メリット

1. **シンプル**: フラグの切り替えだけで済む
2. **復元可能**: 誤削除時もすぐに復元できる
3. **履歴保持**: 過去のデータが維持される
4. **一般的**: 多くのサービスで採用されているパターン
5. **環境変数不要**: Service Role Keyを使った複雑な処理が不要

## 注意点

- 完全にデータを消したい場合（GDPR対応等）は、別途物理削除機能を実装する必要がある
- その場合はSupabase管理画面からの手動削除、またはService Role Keyを使った実装が必要
