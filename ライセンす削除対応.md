# ユーザー削除（論理削除）対応の修正方針

## 現状の問題点

1. 削除されたユーザーはログインできない → **OK**
2. 削除されたメールアドレスで新規登録しようとすると「既に登録されています」エラー → **復元で対応**
3. 管理者側で削除済みアカウントを復帰させるUI/機能がない → **実装済み**
4. 削除済みユーザー欄に名前が残るのが気になる人がいる → **実装済み**

## 推奨する解決策（2段階削除 + 中間テーブル）

### 設計方針

**STAFFテーブルを変更せず、中間テーブル `PERMANENTLY_DELETED_STAFF` で完全削除を管理**

### テーブル構造

```sql
-- 中間テーブル（新規作成）
CREATE TABLE PERMANENTLY_DELETED_STAFF (
  staff_id INT PRIMARY KEY REFERENCES "STAFF"(staff_id) ON DELETE CASCADE,
  deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 状態の定義

| STAFF.is_deleted | PERMANENTLY_DELETED_STAFF | 状態 | 画面表示 |
|------------------|---------------------------|------|----------|
| false | なし | アクティブ | ユーザー管理 |
| true | なし | 削除済み | 削除済みセクション（復元可能） |
| true | あり | 完全削除 | なし（DB保持） |

### メリット

1. **STAFFテーブル変更不要**: 既存コードへの影響ゼロ
2. **シンプル**: 中間テーブル1つ追加するだけ
3. **監査対応**: 完全削除の日時が記録される
4. **データ保持**: 物理削除しないため、過去の投稿との整合性が保たれる
5. **リレーショナルDB的に正しい**: 関心の分離

### フロー図

```
[アクティブユーザー]
    ↓ 削除ボタン
[削除済みユーザー] ← 復元ボタン → [アクティブユーザー]
    ↓ 完全削除ボタン
[完全削除済み]（画面に表示されない、DBには残る）
```

## 実装内容

### 1. データベース変更（マイグレーション）

中間テーブル `PERMANENTLY_DELETED_STAFF` を作成：

```sql
CREATE TABLE IF NOT EXISTS PERMANENTLY_DELETED_STAFF (
  staff_id INT PRIMARY KEY REFERENCES "STAFF"(staff_id) ON DELETE CASCADE,
  deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

COMMENT ON TABLE PERMANENTLY_DELETED_STAFF IS '完全削除されたスタッフを記録（UI非表示だがデータ保持）';
```

### 2. バックエンド修正

- `getDeletedStaff()`: 中間テーブルを参照して完全削除済みを除外
- `permanentlyDeleteStaff()`: 中間テーブルにレコードを挿入

### 3. フロントエンド修正

- 削除済みユーザーセクションを折りたたみ式に（デフォルト閉じる）
- 各削除済みユーザーに「完全削除」ボタンを追加

### UI イメージ

```
┌─────────────────────────────────────────┐
│ ユーザー管理                             │
├─────────────────────────────────────────┤
│ 【アクティブユーザー】                    │
│ ┌─────────────────────────────────────┐ │
│ │ 山田太郎  [管理者] [表示中] [削除]  │ │
│ │ 鈴木花子  [一般]   [非表示] [削除]  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ▶ 削除済みユーザー (2件)  ← クリックで展開│
└─────────────────────────────────────────┘

展開時：
┌─────────────────────────────────────────┐
│ ▼ 削除済みユーザー (2件)                 │
│ ┌─────────────────────────────────────┐ │
│ │ 佐藤次郎  [復元] [完全削除]         │ │
│ │ 田中三郎  [復元] [完全削除]         │ │
│ └─────────────────────────────────────┘ │
│ ※完全削除すると一覧から消えます         │
│   （データは裏で保持されます）           │
└─────────────────────────────────────────┘
```

## 注意点

- 完全削除は取り消し不可（画面から操作できなくなる）
- 必要ならSupabase管理画面から直接DBを操作して復元可能
  - `DELETE FROM PERMANENTLY_DELETED_STAFF WHERE staff_id = ?;`
- 完全削除されたユーザーの過去投稿は引き続き表示される
